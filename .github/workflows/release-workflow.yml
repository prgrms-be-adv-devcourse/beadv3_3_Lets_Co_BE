name: Build and release docker image # ì›Œí¬í”Œë¡œìš°ì˜ ì´ë¦„ì…ë‹ˆë‹¤.

on: # ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤í–‰ë˜ëŠ” íŠ¸ë¦¬ê±° ì¡°ê±´ì„ ì •ì˜í•©ë‹ˆë‹¤.
  workflow_call: # ë‹¤ë¥¸ ì›Œí¬í”Œë¡œìš°ì—ì„œ 'í˜¸ì¶œ(call)'ë  ë•Œë§Œ ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤(ì¬ì‚¬ìš© ê°€ëŠ¥).
    inputs: # í˜¸ì¶œí•  ë•Œ ë„˜ê²¨ë°›ì•„ì•¼ í•  íŒŒë¼ë¯¸í„°(ë³€ìˆ˜)ë“¤ì„ ì •ì˜í•©ë‹ˆë‹¤.
      service-name: # ì„œë¹„ìŠ¤ ì´ë¦„ (ì˜ˆ: gateway-service)
        required: true # í•„ìˆ˜ ì…ë ¥ê°’ì…ë‹ˆë‹¤.
        type: string # ë¬¸ìì—´ íƒ€ì…ì…ë‹ˆë‹¤.
      service-dir: # ì„œë¹„ìŠ¤ ë””ë ‰í† ë¦¬ ê²½ë¡œ (ì˜ˆ: Gateway)
        required: true
        type: string
      file-name: # Dockerfileì˜ ì´ë¦„ (ë³´í†µ Dockerfile)
        required: true
        type: string
      tag-prefix: # [ì¶”ê°€] íƒœê·¸ ì ‘ë‘ì‚¬ ì…ë ¥ ë°›ê¸°
        required: false
        type: string
        default: "v"
    secrets: # í˜¸ì¶œí•  ë•Œ ë„˜ê²¨ë°›ì•„ì•¼ í•  ë³´ì•ˆ ê°’(Secrets)ë“¤ì„ ì •ì˜í•©ë‹ˆë‹¤.
      DOCKER_USERNAME: # Docker Hub ì•„ì´ë””
        required: true
      DOCKER_PASSWORD: # Docker Hub ë¹„ë°€ë²ˆí˜¸/í† í°
        required: true
      APPLICATION_YML: # ìƒì„±í•  application.ymlì˜ ë‚´ìš©
        required: true
    outputs: # ì´ ì›Œí¬í”Œë¡œìš°ê°€ ëë‚œ í›„ ë°˜í™˜í•  ê°’ì„ ì •ì˜í•©ë‹ˆë‹¤.
      tag_name: # ìƒì„±ëœ íƒœê·¸ ì´ë¦„(ë²„ì „)ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
        value: ${{ jobs.tagging.outputs.tag_name }}

env: # ì›Œí¬í”Œë¡œìš° ì „ì²´ì—ì„œ ì‚¬ìš©í•  í™˜ê²½ ë³€ìˆ˜ì…ë‹ˆë‹¤.
  REGISTRY: docker.io # ì‚¬ìš©í•  ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì£¼ì†Œ (Docker Hub)

jobs: # ì‹¤ì œ ìˆ˜í–‰í•  ì‘ì—…ë“¤ì„ ì •ì˜í•©ë‹ˆë‹¤.
  tagging: # ì²« ë²ˆì§¸ ì‘ì—…: ë²„ì „ íƒœê·¸ ìƒì„±
    name: íƒœê¹… ë° ë¦´ë¦¬ì¦ˆ # UIì— í‘œì‹œë  ì‘ì—… ì´ë¦„
    runs-on: ubuntu-latest # ìµœì‹  ìš°ë¶„íˆ¬ í™˜ê²½ì—ì„œ ì‹¤í–‰
    outputs: # ë‹¤ìŒ ì‘ì—…(build-image)ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì¶œë ¥ê°’ì„ ì„¤ì •
      tag_name: ${{ steps.tag_version.outputs.new_tag }} # ìƒˆë¡œ ìƒì„±ëœ íƒœê·¸
      changelog: ${{ steps.tag_version.outputs.changelog }} # ë³€ê²½ ë‚´ì—­

    steps: # ì‘ì—…ì˜ ì„¸ë¶€ ë‹¨ê³„
      - uses: actions/checkout@v5 # í˜„ì¬ ì €ì¥ì†Œì˜ ì½”ë“œë¥¼ ë‚´ë ¤ë°›ìŠµë‹ˆë‹¤.

      - name: versioning and tagging # ë²„ì „ íƒœê·¸ë¥¼ ìƒì„±í•˜ëŠ” ë‹¨ê³„
        id: tag_version # ì´ ë‹¨ê³„ì˜ ID (ì¶œë ¥ê°’ ì°¸ì¡°ìš©)
        uses: mathieudutour/github-tag-action@v6.2 # íƒœê·¸ ìƒì„±ìš© ì•¡ì…˜ ì‚¬ìš©
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }} # ê¹ƒí—ˆë¸Œ ê¶Œí•œ í† í° (ìë™ ìƒì„±ë¨)
          tag_prefix: ${{ inputs.tag-prefix }} # [ì¶”ê°€] ì ‘ë‘ì‚¬ ì ìš©

      - name: releasing # ê¹ƒí—ˆë¸Œ ë¦´ë¦¬ì¦ˆ í˜ì´ì§€ì— ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ë¥¼ ìƒì„±í•˜ëŠ” ë‹¨ê³„
        uses: ncipollo/release-action@v1 # ë¦´ë¦¬ì¦ˆ ìƒì„±ìš© ì•¡ì…˜ ì‚¬ìš©
        with:
          tag: ${{ steps.tag_version.outputs.new_tag }} # ìœ„ì—ì„œ ë§Œë“  íƒœê·¸ ì‚¬ìš©
          name: ${{ steps.tag_version.outputs.new_tag }} # ë¦´ë¦¬ì¦ˆ ì´ë¦„ë„ íƒœê·¸ì™€ ë™ì¼í•˜ê²Œ
          body: ${{ steps.tag_version.outputs.changelog }} # ë³€ê²½ ë¡œê·¸ ë‚´ìš©ì„ ë³¸ë¬¸ì— ì‘ì„±

  build-image: # ë‘ ë²ˆì§¸ ì‘ì—…: ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ
    name: ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: tagging # 'tagging' ì‘ì—…ì´ ì„±ê³µí•´ì•¼ë§Œ ì‹¤í–‰ë¨

    permissions: # ì´ ì‘ì—…ì— í•„ìš”í•œ ê¶Œí•œ ì„¤ì •
      contents: read # ì½”ë“œ ì½ê¸° ê¶Œí•œ
      packages: read # íŒ¨í‚¤ì§€ ì½ê¸° ê¶Œí•œ
      attestations: write # ì¦ëª…ì„œ ì“°ê¸° ê¶Œí•œ
      id-token: write # ID í† í° ì“°ê¸° ê¶Œí•œ

    steps:
      - name: Check out Repository # ì½”ë“œë¥¼ ë‹¤ì‹œ ë‚´ë ¤ë°›ìŠµë‹ˆë‹¤(ìƒˆ ì‘ì—…ì´ë¯€ë¡œ í™˜ê²½ì´ ì´ˆê¸°í™”ë¨).
        uses: actions/checkout@v5

      # [ì¤‘ìš”] Secretsì— ì €ì¥ëœ ì„¤ì • ë‚´ìš©ì„ ì‹¤ì œ íŒŒì¼ë¡œ ë§Œë“œëŠ” ê³¼ì •
      - name: Create application.yml
        run: | # ì—¬ëŸ¬ ì¤„ì˜ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰
          mkdir -p ./${{ inputs.service-dir }}/src/main/resources
          cat << 'EOF' > ./${{ inputs.service-dir }}/src/main/resources/application.yml
          ${{ secrets.APPLICATION_YML }}
          EOF

      # - name: Setup Java 21 # ìë°” í™˜ê²½ ì„¤ì •
      #   uses: actions/setup-java@v5
      #   with:
      #     distribution: temurin # Eclipse Temurin ë°°í¬íŒ ì‚¬ìš©
      #     java-version: 21 # ìë°” 21 ë²„ì „
      #     cache: gradle # Gradle ë¹Œë“œ ìºì‹œ í™œì„±í™” (ì†ë„ í–¥ìƒ)

      # - name: Gradle build # Gradleë¡œ í”„ë¡œì íŠ¸ ë¹Œë“œ
      #   working-directory: ${{ inputs.service-dir }} # í•´ë‹¹ ì„œë¹„ìŠ¤ í´ë”ì—ì„œ ì‹¤í–‰
      #   # ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ í›„ ë¹Œë“œ ìˆ˜í–‰ (í…ŒìŠ¤íŠ¸ëŠ” ì œì™¸ -x test)
      #   run: chmod +x gradlew && ./gradlew clean build -x test --no-daemon

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Sign in to Docker Hub # ë„ì»¤ í—ˆë¸Œ ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata # ë„ì»¤ ì´ë¯¸ì§€ì— ë¶™ì¼ íƒœê·¸ì™€ ë¼ë²¨ ìƒì„±
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ inputs.service-name }}
          tags: |
            type=raw,value=${{ needs.tagging.outputs.tag_name }}

# ğŸ‘‡ [ì—¬ê¸°] ë¹Œë“œ ì§ì „ì— íŒŒì¼ì´ ì§„ì§œ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ë‹¨ê³„
      - name: ğŸ” ì…œë¡í™ˆì¦ˆ ë””ë²„ê¹… (íŒŒì¼ ì‹œìŠ¤í…œ í™•ì¸)
        run: |
          echo "Current Path: $(pwd)"
          
          echo "----------------------------------------------"
          echo "1. Payment í´ë”ê°€ ì¡´ì¬í•˜ëŠ”ê°€?"
          ls -ld Payment || echo "âŒ Payment í´ë” ìì²´ê°€ ì—†ìŒ!"
          
          echo "----------------------------------------------"
          echo "2. Payment í´ë” ì•ˆì— ë¬´ì—‡ì´ ìˆëŠ”ê°€?"
          ls -la Payment || echo "âŒ ì¡°íšŒ ë¶ˆê°€"
          
          echo "----------------------------------------------"
          echo "3. Dockerfileì´ ì¡´ì¬í•˜ëŠ”ê°€? (ëŒ€ì†Œë¬¸ì êµ¬ë¶„)"
          if [ -f "Payment/Dockerfile" ]; then
            echo "âœ… Payment/Dockerfile ë°œê²¬ë¨!"
          else
            echo "âŒ Payment/Dockerfile ì—†ìŒ! (ì•„ë˜ íŒŒì¼ ëª©ë¡ í™•ì¸)"
            find Payment -maxdepth 1
          fi
      - name: Build and Push Image # ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ê³  í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: ./${{ inputs.service-dir }} # ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸ (í•´ë‹¹ ì„œë¹„ìŠ¤ í´ë”)
          file: ./${{ inputs.service-dir }}/${{ inputs.file-name }} # Dockerfile ìœ„ì¹˜
          push: true # ë¹Œë“œ í›„ ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¡œ í‘¸ì‹œí•¨
          tags: ${{ steps.meta.outputs.tags }} # ìœ„ì—ì„œ ë§Œë“  íƒœê·¸ë“¤ ì ìš©
          labels: ${{ steps.meta.outputs.labels }} # ë¼ë²¨ ì ìš©
          cache-from: type=gha # ê¹ƒí—ˆë¸Œ ì•¡ì…˜ ìºì‹œ ì‚¬ìš© (ë¹Œë“œ ì†ë„ í–¥ìƒ)
          cache-to: type=gha,mode=max # ìºì‹œ ì €ì¥
